# blocky lists downloader

Update lists without restarting [blocky](https://0xerr0r.github.io/blocky/) DNS.

## Introduction

[blocky](https://github.com/0xERR0R/blocky) is a DNS proxy that blocks DNS queries based on external lists. It reads blocking lists and allowing list from a configuration file. Everytime we want to add a list or a domain to the blocking or allowing list, we must edit the configuration file, then restart blocky. This may lead to DNS down.

[Block lists downloader](https://github.com/shizunge/blocky-lists-downloader) runs as a companion service, allowing you to edit lists and domains in lists without restarting blocky.

## How it works

* *Lists downloader* downloads and concatenates multiple lists into a single file based on a *source* file that contains URLs to tell where to download lists.
* *Lists downloader* watches changes of the *source* files and/or run downloading periodically.
* *Lists downloader* also watches files of lists of domains. No downloads in this case.
* *Lists downloader* ships with a [static file server](https://github.com/static-web-server/static-web-server), allowing blocky to read the downloaded files.
* *List downloader* sends [refresh requests](https://0xerr0r.github.io/blocky/swagger.html#operation--lists-refresh-post) to blocky.

### Without *lists downloader*

Here is a snippet of a blokcy configuration file. We use this as an example to demostarte how to translate an existing blocky configuration to *lists downloader*.

```
blocking:
  blackLists:
    group-one:
      - https://github.com/StevenBlack/hosts
      - https://github.com/Perflyst/PiHoleBlocklist
    group-two:
      - |
        blocked.example.com
        blocked2.example.com
  clientGroupsBlock:
    default:
      - group-one
      - group-two
```

### Using *lists downloader*

Create a new *source* file for `group-one`, which contains the lists, for example `/sources/group-one.txt`.

```
# Comments are supported
https://github.com/StevenBlack/hosts
https://github.com/Perflyst/PiHoleBlocklist
```

*Lists downloader* reads this *source* file, downloads contents of these two lists, then concatenates them to a single file. The result file will have the same name `group-one.txt`, but it will go to the destination folder e.g. `/web/downloaded`.

Then You modify the blocky configuration file for `group-one` to read the aggregated list from the static file server of *lists downloader* instead of two separated lists.

```
blocking:
  blackLists:
    group-one:
      - http://lists-downloader:8080/downloaded/group-one.txt
```

For now on, if you want to add or remove lists for `group-one`, you no longer need to modify the blocky configuration file. Instead you edit the *source* file `/sources/group-one.txt`. *Lists downloader* will watch the changes of the *source* files, and start new downloads following refresh requests to blocky. *Lists downloader* can also download the lists of domains periodically.

*Lists downloader* also watches files that contain lists of domains besides watching the *source* files. No download will occur in this case.

Create a new file for lists of domains, e.g. `/web/watch/group-two.txt`

```
blocked.example.com
blocked2.example.com
```

Then You modify the blocky configuration file for `group-two` to read this file.

```
blocking:
  blackLists:
    group-two:
      - http://lists-downloader:8080/watch/group-two.txt
```

When you add or remove domains from `group-two.txt`, *lists downloader* will send a refresh request to blocky.

## Configurations

You can configure the most behaviors of *lists downloader* via environment variables.

| Environment Variable  | Default |Description |
|-----------------------|---------|------------|
| BLD_BLOCKY_URL            |       | Enable [refresh request](https://0xerr0r.github.io/blocky/swagger.html#operation--lists-refresh-post) to blocky. It should be the base URL of blocky. Use an empty string to disable refresh requests. |
| BLD_DESTINATION_FOLDER    | /web/downloaded | The location of aggregated lists. This should be under `BLD_WEB_FOLDER` thus blocky can read the files via the static file server. |
| BLD_INITIAL_DELAY_SECONDS | 0     | Delay in seconds before the first download. |
| BLD_INTERVAL_SECONDS      | 86400 | Interval between two downloads. Set to 0 disable periodically downloads, then downloads will only at *source* changes. |
| BLD_LOG_LEVEL             | INFO  | Control how many logs generated by Gantry. Valid values are `NONE`, `ERROR`, `WARN`, `INFO`, `DEBUG` (case sensitive). |
| BLD_NODE_NAME             |       | Add node name to logs. |
| BLD_NOTIFICATION_APPRISE_URL |    | Enable notification after each refresh with [apprise](https://github.com/djmaze/apprise-microservice). This must point to the notification endpoint, e.g. `http://apprise:8000/notify`. Use an empty string to disable notification. |
| BLD_POST_DOWNLOAD_CMD     |       | A command or function running after downloading an aggregated list. The first argument will be the path to the aggregated file, i.e. you command will be eval as `your_command <file_path>`. This can be used to fix problems in the lists before the upstream maintainer fixing it. |
| BLD_SOURCES_FOLDER | /sources   | The location to read sources lists. The files contains URLs where to download the lists of domains. Use an empty string to disable watching. |
| BLD_WATCH_FOLDER   | /web/watch | The location of user defined lists of domains. *lists downloader* watches changes in this folder and send refresh requests to blocky. This should be under `BLD_WEB_FOLDER` thus blocky can read the files via the static file server. Use an empty string to disable watching. |
| BLD_WEB_FOLDER     | /web       | The location which the static file server services. Use an empty string to disable the web server. |
| BLD_WEB_PORT       | 8080       | The port that static-web-server listens to. |

## Caveats

* No web UI

    Blocky lists downloader bases on a set of shell scripts. It does not provide any UI to edit lists. You need an additional service for lists editing.

* No group management

    You still need to modify the blocky configuration file to edit groups.

## Contacts

If you have any problems or questions, please contact me through a [GitHub issue](https://github.com/shizunge/blocky-lists-downloader/issues).

## Related projects

You may also want to check my [blocky Postgresql dashboard](https://github.com/shizunge/blocky-postgresql).